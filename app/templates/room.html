<!-- 
TODO
- calculate last sender
- disable message send if you were the last sender
- order messaages by TS desc
- color in messages / display them nicely
- switch to using markov predictions
-->
<html>
  <head>
    <title>Flask-SocketIO-Chat: {{ room }}</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
    <script
      type="text/javascript"
      src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"
    ></script>

    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <script src="https://unpkg.com/vue"></script>
  </head>
  <body>
    <div class="container">
      <h1>Flask-SocketIO-Chat</h1>
      <textarea id="chat" cols="80" rows="20"></textarea><br /><br />
      <br /><br />
      <a href="#" onclick="leave_room();">Leave this room</a>

      <div id="vueArea">
        {% raw %}
        <div v-if="name">
          I am: {{ name }}<br />
          Other person is: {{ otherUser }}

          <div v-if="lastSender != name">
            <input
              id="text"
              size="80"
              placeholder="Enter your message here"
              v-on:keyup.enter="sendText"
            />
          </div>
          <div v-else>Waiting for {{ otherUser }}</div>
          <span v-for="message in messages">
            {{ message.name }}: {{ message.text }}
          </span>
        </div>
        <div v-else>
          <form>
            <div class="form-group">
              <input
                type="text"
                class="form-control"
                id="name"
                aria-describedby="nameHelp"
                placeholder="Mx. Fox"
                value="Alex"
              />
              <small id="nameHelp" class="form-text text-muted"
                >The name you'll go by in this exquisite sext</small
              >
            </div>
            <button
              type="button"
              class="btn btn-primary"
              @click.prevent="setName"
            >
              Start exquisitely sexting
            </button>
          </form>
        </div>

        {% endraw %}
        <div id="status"></div>
      </div>
    </div>
  </body>
  <script type="text/javascript" charset="utf-8">
    const roomId = '{{ roomId }}';
    const room = JSON.parse('{{ room|tojson|safe}}');
    const messages = JSON.parse('{{ messages|tojson|safe}}');
    const messageArray = _.orderBy(messages.messages, ['ts'], ['desc']);

    let lastSender = null;
    if (messageArray.length == 0) {
      lastSender = room.creator;
    } else {
      lastSender = messageArray[messageArray.length - 1].name;
    }

    console.log(room);

    let initialName = null;
    let otherUser = null;
    if (room.participantSid && !room.creatorSid) {
      initialName = room.creator;
    } else if (room.creatorSid && !room.participantSid) {
      initialName = room.participant;
    }

    let existingRooms = localStorage.getItem('rooms');
    if (!existingRooms) {
      existingRooms = {};
    } else {
      existingRooms = JSON.parse(existingRooms);
    }

    if (existingRooms[roomId]) {
      initialName = existingRooms[roomId].name;
    }

    if (initialName == room.creator) {
      otherUser = room.participant;
    } else if (initialName == room.participant) {
      otherUser = room.creator;
    }

    const app = new Vue({
      el: '#vueArea',
      data: {
        name: initialName,
        messages: messageArray,
        lastSender,
        otherUser
      },
      methods: {
        setName: function(event) {
          if ($('#name').val() == room.creator) {
            alert('hey, choose a different name from the creator of the room');
            return true;
          }
          this.name = $('#name').val();

          let existingRooms = localStorage.getItem('rooms');
          if (!existingRooms) {
            existingRooms = {};
          } else {
            existingRooms = JSON.parse(existingRooms);
          }
          existingRooms[roomId] = {
            name: $('#name').val()
          };
          localStorage.setItem('rooms', JSON.stringify(existingRooms));

          joinRoom();
        },
        sendText: function() {
          console.log('send text');
          text = $('#text').val();
          console.log('trying to send');
          if (code == 13 && text.length > 0) {
            $('#text').val('');
            app.lastSender = app.name;
            console.log('trying to send / set sender');
            socket.emit('text', { name: app.name, roomId: roomId, text: text });
          }
        }
      }
    });

    function joinRoom() {
      socket.emit('joined', {
        name: app.name,
        roomId: roomId
      });
    }

    var socket;
    $(document).ready(function() {
      socket = io.connect(
        'http://' + document.domain + ':' + location.port + '/chat'
      );
      socket.on('connect', function() {
        if (!!app.name) {
          joinRoom();
        }
      });
      socket.on('status', function(data) {
        $('#status').val($('#status').val() + '<' + data.msg + '>\n');
        $('#status').scrollTop($('#status')[0].scrollHeight);
      });
      socket.on('message', function(data) {
        console.log(data);
        app.lastSender = data.name;
        app.messages.push(data);
        // $('#chat').val($('#chat').val() + data.msg + '\n');
        // $('#chat').scrollBottom($('#chat')[0].scrollHeight);
      });
      socket.on('setParticipant', function(data) {
        app.otherUser = data.name;
      });
    });

    function leave_room() {
      socket.emit('left', {}, function() {
        socket.disconnect();
      });
    }
  </script>
</html>
